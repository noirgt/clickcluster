# Clickhouse Cluster with Ansible
## _Проект, позволяющий быстро развернуть тестовый кластер Clickhouse с репликацией через Zookeeper_ 
- Описание простой конфигурации в `.yaml`-файле с описанием shard-ов и реплик;
- Формирование всех необходимых переменных для playbook в dynamic inventory;
- Поднятие кластера Clickhouse при помощи Ansible.

![ansible](./images/ansible-logo.png) ![clickhouse](./images/clickhouse-logo.png)

## Конфигурация
Отредактируйте файл `config.yml` и добавьте туда описание своего кластера. Например:
```yml
1:
  - 10.102.3.11
  - 10.102.3.13
2:
  - 10.102.3.12
  - 10.102.3.11

3:
  - 10.102.3.13
  - 10.102.3.12
```
> Мы указываем, что **шард #1** будет расположен на нодах с IP-адресами: `10.102.3.11` и `10.102.3.13`;
> 
> **Шард #2** -  на нодах `10.102.3.12` и `10.102.3.11`;
> 
> **Шард #3** - на нодах `10.102.3.13` и `10.102.3.12`. 

Получается следующая структура:

![cluster-example-scheme](./images/cluster-example-scheme.png)

Исходя из конфигурации на каждой ноде формируется `docker-compose`-файл с содержимым:
- Clickhouse-реплики для каждого шарда, описанного в конфигурации;
- Zookeeper контейнер для репликации.
> Если на одну ноду выпадает **больше** двух контейнеров с репликами Clickhouse, на одной ноде
> запускаются **2** контейнера Zookeeper.

Конфигурация, описанная в файле `config.yml` формирует необходимую JSON-структуру для передачи в Ansible.
Например, конфигурация описанная в примере выше передаст в playbook следующее:
```json
{"clickhouse": {
    "hosts": [
        "10.102.3.11", 
        "10.102.3.13", 
        "10.102.3.12"], 
    "vars": {
        "distr_structure": [
            [
                [1, "ch1_rep1"], 
                [2, "ch2_rep2"]], 
            [
                [1, "ch1_rep2"], 
                [3, "ch3_rep1"]], 
            [
                [2, "ch2_rep1"], 
                [3, "ch3_rep2"]]], 
        "zoo_structure": [
            [1, "zk1"], 
            [2, "zk2"], 
            [3, "zk3"]], 
        "full_distr_cluster": {
            "1": ["ch1_rep1", "ch1_rep2"], 
            "2": ["ch2_rep2", "ch2_rep1"], 
            "3": ["ch3_rep1", "ch3_rep2"]}}}, 
"_meta": {
    "hostvars": {
        "10.102.3.11": {
            "click_containers": [[1, "ch1_rep1"], [2, "ch2_rep2"]], 
            "zoo_containers": [[1, "zk1"]], 
            "extra_hosts": [
                "ch1_rep2:10.102.3.13", 
                "ch3_rep1:10.102.3.13", 
                "zk3:10.102.3.13", 
                "ch2_rep1:10.102.3.12", 
                "ch3_rep2:10.102.3.12", 
                "zk2:10.102.3.12"], 
            "zoo_servers": ["0.0.0.0:2888:3888,zk2:2888:3888,zk3:2888:3888"]}, 
        "10.102.3.13": {
            "click_containers": [[1, "ch1_rep2"], [3, "ch3_rep1"]], 
            "zoo_containers": [[3, "zk3"]], 
            "extra_hosts": [
                "ch1_rep1:10.102.3.11", 
                "ch2_rep2:10.102.3.11", 
                "zk1:10.102.3.11", 
                "ch2_rep1:10.102.3.12", 
                "ch3_rep2:10.102.3.12", 
                "zk2:10.102.3.12"], 
            "zoo_servers": ["zk1:2888:3888,zk2:2888:3888,0.0.0.0:2888:3888"]}, 
        "10.102.3.12": {
            "click_containers": [[2, "ch2_rep1"], [3, "ch3_rep2"]], 
            "zoo_containers": [[2, "zk2"]], 
            "extra_hosts": [
                "ch1_rep1:10.102.3.11", 
                "ch2_rep2:10.102.3.11", 
                "zk1:10.102.3.11", 
                "ch1_rep2:10.102.3.13", 
                "ch3_rep1:10.102.3.13", 
                "zk3:10.102.3.13"], 
            "zoo_servers": ["zk1:2888:3888,0.0.0.0:2888:3888,zk3:2888:3888"]}}}}
```
Ansible принимает данную структуру в качестве переменных для группы хостов `Clickhouse`
и персональных для каждого хоста в отдельности. Здесь передаются:
- Структура кластера Zookeeper, осуществляющего репликацию таблиц;
- Extra hosts для связи между контейнерами на разных нодах;
- Описание всех номеров шардов и контейнеров, которые относятся к ним.

> Формирование `docker-compose`-файлов и конфигурации кластера описано
> в `.jinja2`-шаблонах Ansible-роли `click-structure`.
